name: Deploy to Outerbounds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        pytest tests/ -v

  deploy:
    name: Deploy to Outerbounds
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python3 -m pip install -U requests
        python3 -m pip install outerbounds pyyaml
        python3 -m pip install -U ob-project-utils

    - name: Configure Outerbounds
      run: |
        PROJECT_NAME=$(grep "^project = " obproject.toml | cut -d "'" -f 2)
        PLATFORM=$(grep "^platform = " obproject.toml | cut -d "'" -f 2)
        outerbounds service-principal-configure \
          --name "$PROJECT_NAME" \
          --deployment-domain "$PLATFORM" \
          --github-actions

    - name: Deploy Project
      run: |
        obproject-deploy
      env:
        GITHUB_TOKEN: ${{ github.token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
